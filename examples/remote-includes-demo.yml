# Remote Includes Demo
# Shows how to include recipes from remote sources
version: 1.0

# Include recipes from various remote sources
include:
  # Local includes (already working)
  - "shared/docker-common.yml"
  
  # HTTP/HTTPS includes - raw file URLs
  - "https://raw.githubusercontent.com/phillarmonic/drun-recipes/main/docker/common.yml"
  - "https://raw.githubusercontent.com/phillarmonic/drun-recipes/main/ci/github-actions.yml"
  
  # Git includes with branch/tag references
  - "git+https://github.com/phillarmonic/drun-recipes.git@main:docker/advanced.yml"
  - "git+https://github.com/phillarmonic/drun-recipes.git@v1.0.0:ci/common.yml"
  - "git+https://github.com/company/internal-recipes.git@develop:shared/secrets.yml"
  
  # Git includes with default paths (will look for drun.yml)
  - "git+https://github.com/phillarmonic/drun-base-recipes.git@stable"

env:
  PROJECT_NAME: "remote-demo"
  VERSION: "{{ gitShortCommit }}"

recipes:
  # Demonstrate remote includes usage
  show-remote-includes:
    help: "Show what remote includes would provide"
    run: |
      {{ step "Remote Includes Demonstration" }}
      
      {{ warn "Remote includes not yet fully implemented - this is a preview" }}
      
      echo "üåê REMOTE INCLUDE SOURCES:"
      echo ""
      
      echo "üìÅ HTTP/HTTPS Includes:"
      echo "  ‚Ä¢ https://raw.githubusercontent.com/org/repo/main/file.yml"
      echo "  ‚Ä¢ Direct file access from GitHub, GitLab, etc."
      echo "  ‚Ä¢ Simple caching based on URL"
      echo ""
      
      echo "üîó Git Includes:"
      echo "  ‚Ä¢ git+https://github.com/org/repo.git@main:path/file.yml"
      echo "  ‚Ä¢ git+https://github.com/org/repo.git@v1.0.0:drun.yml"
      echo "  ‚Ä¢ git+https://github.com/org/repo.git@develop"
      echo "  ‚Ä¢ Full Git repository cloning with ref checkout"
      echo "  ‚Ä¢ Intelligent caching and updates"
      echo ""
      
      {{ success "Remote includes will enable powerful recipe sharing!" }}

  # Test current local includes
  test-local-includes:
    help: "Test current local includes functionality"
    deps: [docker-info]  # This should come from shared/docker-common.yml
    run: |
      {{ step "Testing local includes" }}
      
      {{ info "Local includes are working!" }}
      {{ info "The docker-info recipe came from shared/docker-common.yml" }}
      
      # Use snippet from included file
      {{ snippet "docker_check" }}
      
      {{ success "Local includes test completed" }}

  # Simulate remote recipe usage
  simulate-remote-recipes:
    help: "Simulate using recipes from remote sources"
    run: |
      {{ step "Simulating remote recipe usage" }}
      
      echo "üöÄ COMMON REMOTE RECIPE PATTERNS:"
      echo ""
      
      echo "1. Docker Recipes (from docker/common.yml):"
      echo "   ‚Ä¢ docker-build-multi-arch"
      echo "   ‚Ä¢ docker-security-scan"
      echo "   ‚Ä¢ docker-compose-dev"
      echo ""
      
      echo "2. CI/CD Recipes (from ci/github-actions.yml):"
      echo "   ‚Ä¢ setup-node-cache"
      echo "   ‚Ä¢ run-tests-matrix"
      echo "   ‚Ä¢ deploy-to-staging"
      echo ""
      
      echo "3. Security Recipes (from shared/secrets.yml):"
      echo "   ‚Ä¢ vault-login"
      echo "   ‚Ä¢ rotate-api-keys"
      echo "   ‚Ä¢ security-audit"
      echo ""
      
      echo "4. Base Recipes (from drun-base-recipes.git):"
      echo "   ‚Ä¢ init-project"
      echo "   ‚Ä¢ setup-git-hooks"
      echo "   ‚Ä¢ generate-docs"
      echo ""
      
      {{ success "Remote recipes would provide rich ecosystem!" }}

  # Show caching behavior
  show-caching:
    help: "Show remote include caching behavior"
    run: |
      {{ step "Remote Include Caching" }}
      
      echo "üì¶ CACHING STRATEGY:"
      echo ""
      
      echo "HTTP Includes:"
      echo "  ‚Ä¢ Cache location: ~/.drun/cache/includes/http_<hash>"
      echo "  ‚Ä¢ Cache key: SHA256 hash of URL"
      echo "  ‚Ä¢ TTL: 1 hour (configurable)"
      echo "  ‚Ä¢ Validation: ETag/Last-Modified headers"
      echo ""
      
      echo "Git Includes:"
      echo "  ‚Ä¢ Cache location: ~/.drun/cache/includes/git_<hash>"
      echo "  ‚Ä¢ Cache key: SHA256 hash of repo+ref+path"
      echo "  ‚Ä¢ Update strategy: git fetch on cache miss"
      echo "  ‚Ä¢ Shallow clones for efficiency"
      echo ""
      
      echo "Cache Management:"
      echo "  ‚Ä¢ drun cache clear --includes"
      echo "  ‚Ä¢ drun cache stats"
      echo "  ‚Ä¢ Automatic cleanup of old entries"
      echo ""
      
      {{ success "Smart caching ensures fast performance!" }}

  # Security considerations
  show-security:
    help: "Show security considerations for remote includes"
    run: |
      {{ step "Remote Include Security" }}
      
      echo "üîí SECURITY FEATURES:"
      echo ""
      
      echo "‚úÖ IMPLEMENTED:"
      echo "  ‚Ä¢ HTTPS-only for HTTP includes (enforced)"
      echo "  ‚Ä¢ Git repository authentication support"
      echo "  ‚Ä¢ Sandboxed cache directories"
      echo "  ‚Ä¢ URL validation and sanitization"
      echo ""
      
      echo "üöß PLANNED:"
      echo "  ‚Ä¢ Content integrity verification (checksums)"
      echo "  ‚Ä¢ Signature verification for trusted sources"
      echo "  ‚Ä¢ Allowlist/blocklist for remote sources"
      echo "  ‚Ä¢ Audit logging for remote fetches"
      echo ""
      
      echo "‚ö†Ô∏è  BEST PRACTICES:"
      echo "  ‚Ä¢ Pin to specific tags/commits in production"
      echo "  ‚Ä¢ Use private repositories for sensitive recipes"
      echo "  ‚Ä¢ Regular security audits of included recipes"
      echo "  ‚Ä¢ Monitor for supply chain attacks"
      echo ""
      
      {{ success "Security is a top priority!" }}

  # Performance considerations
  show-performance:
    help: "Show performance optimizations"
    run: |
      {{ step "Remote Include Performance" }}
      
      echo "‚ö° PERFORMANCE OPTIMIZATIONS:"
      echo ""
      
      echo "Network Efficiency:"
      echo "  ‚Ä¢ Parallel fetching of multiple includes"
      echo "  ‚Ä¢ Connection pooling and keep-alive"
      echo "  ‚Ä¢ Compression support (gzip, brotli)"
      echo "  ‚Ä¢ Smart retry with exponential backoff"
      echo ""
      
      echo "Git Optimizations:"
      echo "  ‚Ä¢ Shallow clones (--depth 1)"
      echo "  ‚Ä¢ Sparse checkout for specific files"
      echo "  ‚Ä¢ Delta compression for updates"
      echo "  ‚Ä¢ Background cache warming"
      echo ""
      
      echo "Caching Strategy:"
      echo "  ‚Ä¢ Memory cache for frequently used includes"
      echo "  ‚Ä¢ Disk cache with LRU eviction"
      echo "  ‚Ä¢ Conditional requests (If-Modified-Since)"
      echo "  ‚Ä¢ Preemptive cache updates"
      echo ""
      
      {{ success "Optimized for speed and efficiency!" }}

  # Future roadmap
  remote-includes-roadmap:
    help: "Show remote includes implementation roadmap"
    run: |
      {{ step "Remote Includes Roadmap" }}
      echo "================================="
      echo ""
      
      echo "üöß PHASE 1: Basic Implementation (Current)"
      echo "  ‚úÖ URL parsing and validation"
      echo "  ‚úÖ HTTP/HTTPS fetching with caching"
      echo "  ‚úÖ Git repository cloning and checkout"
      echo "  ‚úÖ Cache management and cleanup"
      echo ""
      
      echo "üîÑ PHASE 2: Enhanced Features"
      echo "  ‚Ä¢ Authentication for private repositories"
      echo "  ‚Ä¢ Content integrity verification"
      echo "  ‚Ä¢ Advanced caching strategies"
      echo "  ‚Ä¢ Performance monitoring"
      echo ""
      
      echo "‚ö° PHASE 3: Advanced Integrations"
      echo "  ‚Ä¢ Registry support (like Docker Hub)"
      echo "  ‚Ä¢ Package manager integration"
      echo "  ‚Ä¢ Dependency resolution"
      echo "  ‚Ä¢ Version constraints and semver"
      echo ""
      
      echo "üéØ PHASE 4: Ecosystem Features"
      echo "  ‚Ä¢ Recipe marketplace"
      echo "  ‚Ä¢ Community contributions"
      echo "  ‚Ä¢ Quality scoring and reviews"
      echo "  ‚Ä¢ Automated security scanning"
      echo ""
      
      {{ success "Building the future of recipe sharing!" }}

  # Quick start guide
  remote-quick-start:
    help: "Quick start guide for remote includes"
    run: |
      {{ step "üöÄ Remote Includes Quick Start" }}
      echo "======================================"
      echo ""
      
      echo "1Ô∏è‚É£  BASIC HTTP INCLUDE:"
      echo "   include:"
      echo "     - \"https://raw.githubusercontent.com/org/repo/main/drun.yml\""
      echo ""
      
      echo "2Ô∏è‚É£  GIT INCLUDE WITH BRANCH:"
      echo "   include:"
      echo "     - \"git+https://github.com/org/repo.git@main:recipes/docker.yml\""
      echo ""
      
      echo "3Ô∏è‚É£  GIT INCLUDE WITH TAG:"
      echo "   include:"
      echo "     - \"git+https://github.com/org/repo.git@v1.0.0:drun.yml\""
      echo ""
      
      echo "4Ô∏è‚É£  MIXED LOCAL AND REMOTE:"
      echo "   include:"
      echo "     - \"local/common.yml\""
      echo "     - \"https://example.com/shared.yml\""
      echo "     - \"git+https://github.com/org/recipes.git@stable\""
      echo ""
      
      echo "5Ô∏è‚É£  CACHE MANAGEMENT:"
      echo "   drun cache clear --includes    # Clear include cache"
      echo "   drun cache stats              # Show cache statistics"
      echo ""
      
      {{ success "Ready to use remote includes! üåê" }}
